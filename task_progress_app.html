<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô + ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: "Prompt", sans-serif; background: #f4f6f8; padding: 30px; }
  .container {
    max-width: 900px; margin: auto; background: white; padding: 20px;
    border-radius: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  }
  h2, h3 { text-align: center; color: #333; }
  input, button {
    padding: 8px; margin: 5px; border-radius: 8px; border: 1px solid #ccc;
  }
  button {
    background-color: #007bff; color: white; border: none; cursor: pointer;
  }
  button:hover { background-color: #0056b3; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
  .progress-container { background: #eee; border-radius: 10px; overflow: hidden; }
  .progress-bar { height: 20px; background: #28a745; color: white; text-align: center; transition: width 0.5s; }
  img.thumb { width: 60px; height: 40px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 1px solid #ccc; }
  .logout-btn { background: #dc3545; float: right; }
  .due-soon { color: #dc3545; font-weight: bold; }
  #detailModal, #reportModal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6); align-items: center; justify-content: center;
  }
  .modal-content {
    background: white; padding: 20px; border-radius: 15px; text-align: center;
    max-width: 500px; width: 90%;
  }
  .modal-content img { width: 100%; border-radius: 10px; margin-top: 10px; }
</style>
</head>
<body>

<div class="container" id="loginBox">
  <h2>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
  <input type="text" id="username" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
  <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
  <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<div class="container" id="appBox" style="display:none;">
  <button class="logout-btn" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  <h2>üìä ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</h2>
  <h3 id="userWelcome"></h3>

  <div id="addSection">
    <input type="text" id="taskName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <input type="file" id="taskImage" accept="image/*">
    <button onclick="addTask()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
  </div>

  <table id="taskTable">
    <thead>
      <tr>
        <th>‡∏£‡∏π‡∏õ</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th>
        <th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
        <th>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å</th>
        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="text-align:center; margin-top:20px;">
    <button id="reportBtn" style="display:none;" onclick="openReport()">üìà ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>
</div>

<!-- Modal: ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
<div id="detailModal">
  <div class="modal-content">
    <h3 id="detailName"></h3>
    <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°: <span id="detailStart"></span></p>
    <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: <span id="detailEnd"></span></p>
    <p>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å: <span id="detailRemain"></span> ‡∏ß‡∏±‡∏ô</p>
    <p>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: <span id="detailProgress"></span>%</p>
    <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="detailStatus"></span></p>
    <img id="detailImage" src="">
    <br><br>
    <button onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<!-- Modal: ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
<div id="reportModal">
  <div class="modal-content">
    <h3>üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
    <canvas id="reportChart"></canvas>
    <br>
    <button onclick="closeReport()">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script>
let currentUser = null;
let users = JSON.parse(localStorage.getItem("users")) || {};
function saveUsers() { localStorage.setItem("users", JSON.stringify(users)); }

// üîê ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  if (!username || !password) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô");
  if (!users[username]) users[username] = { password, tasks: [] };
  else if (users[username].password !== password) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
  currentUser = username;
  saveUsers();
  showApp();
}
function logout() {
  currentUser = null;
  document.getElementById("loginBox").style.display = "block";
  document.getElementById("appBox").style.display = "none";
}

// üìÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞ progress
function calcProgress(start, end) {
  const now = new Date();
  const s = new Date(start);
  const e = new Date(end);
  if (now <= s) return 0;
  if (now >= e) return 100;
  return Math.round(((now - s) / (e - s)) * 100);
}
function daysLeft(end) {
  const now = new Date();
  const e = new Date(end);
  const diff = Math.ceil((e - now) / (1000 * 60 * 60 * 24));
  return diff;
}
function getStatus(p) {
  if (p === 100) return "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
  if (p > 0) return "üü° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥";
  return "‚ö™ ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°";
}

// üßÆ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
function showApp() {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("appBox").style.display = "block";
  document.getElementById("userWelcome").textContent = `üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${currentUser}`;
  document.getElementById("addSection").style.display = (currentUser === "dev") ? "block" : "none";
  document.getElementById("reportBtn").style.display = (currentUser === "dev") ? "inline-block" : "none";
  renderTable();
  if (currentUser === "dev") checkDueSoon();
}

// üßÆ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function renderTable() {
  const tbody = document.querySelector("#taskTable tbody");
  tbody.innerHTML = "";
  const tasks = users[currentUser].tasks;

  tasks.forEach((task, index) => {
    const progress = calcProgress(task.start, task.end);
    const remain = daysLeft(task.end);
    task.progress = progress;
    const dueClass = (remain <= 3 && progress < 100) ? "due-soon" : "";
    const dueText = (remain > 0) ? `${remain} ‡∏ß‡∏±‡∏ô` : (progress < 100 ? "‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î!" : "-");

    const row = document.createElement("tr");
    const imgSrc = task.image ? task.image : "";
    row.innerHTML = `
      <td>${imgSrc ? `<img src="${imgSrc}" class="thumb" onclick="openModal(${index})">` : "-"}</td>
      <td>${task.name}</td>
      <td>${task.start} ‚Üí ${task.end}</td>
      <td class="${dueClass}">${dueText}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${progress}%;">${progress}%</div>
        </div>
      </td>
      <td>${getStatus(progress)}</td>
      <td>${currentUser === "dev" ? `<button onclick="openModal(${index})">‡∏î‡∏π</button>` : "-"}</td>
    `;
    tbody.appendChild(row);
  });
  saveUsers();
}

// üßÆ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
function addTask() {
  const name = document.getElementById("taskName").value.trim();
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const file = document.getElementById("taskImage").files[0];
  if (!name || !start || !end) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

  const handleSave = (imgData=null) => {
    users[currentUser].tasks.push({ name, start, end, image: imgData });
    saveUsers(); renderTable();
    document.getElementById("taskName").value = "";
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("taskImage").value = "";
  };

  if (file) {
    const reader = new FileReader();
    reader.onload = e => handleSave(e.target.result);
    reader.readAsDataURL(file);
  } else handleSave();
}

// üîî ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î
function checkDueSoon() {
  const tasks = users[currentUser].tasks;
  const dueSoon = tasks.filter(t => daysLeft(t.end) <= 3 && daysLeft(t.end) >= 0 && calcProgress(t.start, t.end) < 100);
  if (dueSoon.length > 0) {
    alert(`üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏°‡∏µ ${dueSoon.length} ‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î!\n${dueSoon.map(t => "‚Ä¢ " + t.name).join("\n")}`);
  }
}

// üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function openModal(index) {
  const task = users[currentUser].tasks[index];
  const progress = calcProgress(task.start, task.end);
  document.getElementById("detailName").textContent = task.name;
  document.getElementById("detailStart").textContent = task.start;
  document.getElementById("detailEnd").textContent = task.end;
  document.getElementById("detailRemain").textContent = daysLeft(task.end);
  document.getElementById("detailProgress").textContent = progress;
  document.getElementById("detailStatus").textContent = getStatus(progress);
  document.getElementById("detailImage").src = task.image || "";
  document.getElementById("detailModal").style.display = "flex";
}
function closeModal() { document.getElementById("detailModal").style.display = "none"; }

// üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏° (dev)
function openReport() {
  const tasks = users[currentUser].tasks;
  const labels = tasks.map(t => t.name);
  const data = tasks.map(t => calcProgress(t.start, t.end));
  const ctx = document.getElementById("reportChart").getContext("2d");
  if (window.reportChart) window.reportChart.destroy();
  window.reportChart = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ label: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (%)", data }] },
    options: { scales: { y: { beginAtZero: true, max: 100 } } }
  });
  document.getElementById("reportModal").style.display = "flex";
}
function closeReport() { document.getElementById("reportModal").style.display = "none"; }
</script>
<script src="https://cdn.emailjs.com/sdk/3.2/email.min.js"></script>
<script>
  emailjs.init('YOUR_PUBLIC_KEY');
  function sendEmailNotifications(tasks){
    const msg = tasks.map(t => `${t.name} ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysLeft(t.end)} ‡∏ß‡∏±‡∏ô`).join('\n');
    emailjs.send('YOUR_SERVICE_ID','YOUR_TEMPLATE_ID',{message: msg})
      .then(()=>alert('‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚úÖ'))
      .catch(e=>alert('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e));
  }
</script>

</body>
</html>
